<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>麻雀</title>
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#1f2937;
      --tile-bg:#fff;
      --tile-border:#ddd;
      --text:#e6eef8;
      --muted:#9aa7b8;
      --active:#10b981;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071025);color:var(--text);font-family:Inter, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;}
    .app{display:flex;flex-direction:column;gap:12px;min-height:100vh;padding:18px;box-sizing:border-box;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    header h1{margin:0;font-size:18px;font-weight:600;}
    header .controls{display:flex;gap:8px;align-items:center;}
    button{background:var(--accent);color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer;}
    button:hover{opacity:0.95;transform:translateY(-1px);}
    main{display:flex;gap:12px;flex:1;}
    .left-panel{width:360px;display:flex;flex-direction:column;gap:12px;}
    .panel{background:linear-gradient(180deg,var(--panel),#081020);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .game-area{flex:1;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;position:relative;}
    /* 麻雀テーブルのレイアウト */
    .table{
      width:720px;height:480px;border-radius:20px;background:radial-gradient(ellipse at center,#08303a 0%, #021018 60%);
      display:grid;grid-template-columns:1fr auto 1fr;grid-template-rows:1fr auto 1fr;padding:18px;box-sizing:border-box;
      align-items:center;justify-items:center;gap:12px;
      position:relative;
    }
    .player-zone{width:260px;height:80px;background:rgba(255,255,255,0.02);border-radius:8px;display:flex;align-items:center;gap:8px;padding:8px;box-sizing:border-box;transition:box-shadow .18s, transform .12s;}
    .player-zone.active{box-shadow:0 0 0 2px rgba(16,185,129,0.16), 0 6px 14px rgba(2,6,23,0.6);transform:translateY(-4px);}
    .player-zone .name{font-size:14px;color:var(--muted);}
    .hand{display:flex;gap:6px;overflow:auto;padding:6px;}
    .tile{
      min-width:44px;height:64px;background:var(--tile-bg);color:#222;border-radius:6px;border:1px solid var(--tile-border);
      display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.4);
      cursor:pointer;user-select:none;
    }
    .tile.locked{opacity:0.4;cursor:default;}
    .wall{width:160px;height:36px;background:linear-gradient(90deg,#0a5566,#053a44);border-radius:6px;display:flex;align-items:center;justify-content:center;color:#cfeff5;font-weight:600;}
    .discards{width:320px;height:120px;background:rgba(0,0,0,0.15);border-radius:8px;padding:8px;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:28px;gap:6px;overflow:auto;}
    .log{height:120px;overflow:auto;background:linear-gradient(180deg,#031621,#001018);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted);}
    .status{font-size:13px;color:var(--muted);}
    footer{display:flex;gap:8px;align-items:center;justify-content:space-between;}
    .muted-small{font-size:12px;color:var(--muted);}
    @media(max-width:900px){
      .table{width:100%;height:420px;}
      .left-panel{width:100%;}
      main{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>麻雀サイト（開発ベース）</h1>
      <div class="controls">
        <button id="btn-deal">配牌 (Deal)</button>
        <button id="btn-draw">ツモ (Draw)</button>
        <button id="btn-reset">リセット</button>
        <div class="status" id="status">状態: 待機中</div>
      </div>
    </header>

    <main>
      <div class="left-panel">
        <div class="panel">
          <h3 style="margin:0 0 8px 0;">プレイヤー</h3>
          <div id="players">
            <!-- プレイヤーリスト（自分は東家として index 0） -->
            <div class="player-zone" data-player="0" id="player-0"><div style="flex:1"><div class="name">東: あなた</div><div class="hand" id="hand-0"></div></div></div>
            <div class="player-zone" data-player="1" id="player-1"><div style="flex:1"><div class="name">南: プレイヤー2</div><div class="hand" id="hand-1"></div></div></div>
            <div class="player-zone" data-player="2" id="player-2"><div style="flex:1"><div class="name">西: プレイヤー3</div><div class="hand" id="hand-2"></div></div></div>
            <div class="player-zone" data-player="3" id="player-3"><div style="flex:1"><div class="name">北: プレイヤー4</div><div class="hand" id="hand-3"></div></div></div>
          </div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">捨て牌</h3>
          <div class="discards" id="discards"></div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">ログ</h3>
          <div class="log" id="log"></div>
        </div>
      </div>

      <div class="game-area panel">
        <div class="table" id="table">
          <div style="grid-column:1 / span 3; display:flex;align-items:center;justify-content:center;gap:12px;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
              <div class="player-zone" style="width:340px;height:86px;display:flex;align-items:center;justify-content:center;">
                <div style="text-align:center;">
                  <div class="name">上家 (南側)</div>
                  <div id="hand-top" class="hand" style="justify-content:center;"></div>
                </div>
              </div>
            </div>
          </div>

          <div style="grid-row:2;grid-column:2;display:flex;flex-direction:column;align-items:center;gap:12px;">
            <div class="wall" id="wall">山: 0</div>
            <div class="wall" id="turn">ターン: -</div>
          </div>

          <div style="grid-row:3;grid-column:1 / span 3;display:flex;align-items:center;justify-content:center;gap:12px;">
            <div class="player-zone" style="width:520px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <div style="text-align:center;">
                <div class="name">下家 (あなた側)</div>
                <div id="hand-bottom" class="hand" style="margin-top:8px;"></div>
              </div>
            </div>
          </div>

        </div>

        <footer style="width:100%;">
          <div style="display:flex;gap:8px;">
            <button id="btn-auto-play">自動プレイ (簡易AI)</button>
            <button id="btn-show-tiles">タイルセット 表示</button>
            <button id="btn-eval-yaku">役判定</button>
          </div>

          <div style="font-size:13px;color:var(--muted);">
            開発用ベース UI — 機能を拡張して実ゲームを実装してください
          </div>
        </footer>
      </div>
    </main>
  </div>

  <!-- yaku.js を同じディレクトリに置いてください -->
  <script src="yaku.js"></script>

  <script>
    // ----- 簡易的な麻雀タイル表現と改良点 -----
    // 主な改良:
    // - タイルの安定したソート（数牌→字牌の順でソート）
    // - ツモ（Draw）は手番かつ手牌枚数が13枚のときだけ可能に
    // - プレイヤーの手番ハイライト
    // - AI のツモ切り挙動を安定化（非同期で currentTurn の変動に依存しない）
    // - 捨て牌をクリックするとログに詳細表示
    // - UI の状態表示とボタンの有効/無効管理

    const suits = ['m','p','s'];
    // 牌生成
    function buildWall(){
      const w = [];
      for(const s of suits){
        for(let i=1;i<=9;i++){
          for(let c=0;c<4;c++){
            w.push(i + s);
          }
        }
      }
      // 字牌
      const honors = ['E','S','W','N','P','F','C']; // 東南西北 白 發 中
      for(const h of honors){
        for(let c=0;c<4;c++) w.push(h);
      }
      return w;
    }

    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
    }

    // タイルソートキー（安定ソートを実現）
    function tileKey(t){
      // 数牌: 1m..9m, 1p..9p, 1s..9s
      const m = t.match(/^(\d)([mps])$/);
      if(m){
        const num = parseInt(m[1],10);
        const suit = m[2];
        const suitOrder = {'m':0,'p':1,'s':2}[suit];
        // 基本キーを作る（数牌は0..29）
        return suitOrder * 10 + num;
      }
      // 字牌の順序を指定（E S W N P F C）
      const honorsOrder = {'E':31,'S':32,'W':33,'N':34,'P':35,'F':36,'C':37};
      return honorsOrder[t] || 999;
    }

    function sortTiles(arr){
      arr.sort((a,b)=>{
        const ka = tileKey(a);
        const kb = tileKey(b);
        if(ka !== kb) return ka - kb;
        return a.localeCompare(b);
      });
    }

    // ゲーム状態
    const state = {
      wall: [],
      hands: [[],[],[],[]],
      discards: [], // {player, tile}
      turn: 0 // プレイヤー index (0=東=あなた)
    };

    // DOM elements
    const logEl = document.getElementById('log');
    const handEls = [document.getElementById('hand-0'),document.getElementById('hand-1'),document.getElementById('hand-2'),document.getElementById('hand-3')];
    const discardsEl = document.getElementById('discards');
    const wallEl = document.getElementById('wall');
    const statusEl = document.getElementById('status');
    const turnEl = document.getElementById('turn');
    const drawBtn = document.getElementById('btn-draw');

    function log(msg){
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML = `<div>[${time}] ${msg}</div>` + logEl.innerHTML;
    }

    function clearActivePlayerUI(){
      for(let i=0;i<4;i++){
        const el = document.getElementById(`player-${i}`);
        if(el) el.classList.remove('active');
      }
    }

    function setActivePlayerUI(idx){
      clearActivePlayerUI();
      const el = document.getElementById(`player-${idx}`);
      if(el) el.classList.add('active');
    }

    function renderHands(){
      for(let i=0;i<4;i++){
        const el = handEls[i];
        el.innerHTML = '';
        for(let j=0;j<state.hands[i].length;j++){
          const t = state.hands[i][j];
          const tileEl = document.createElement('div');
          tileEl.className = 'tile';
          tileEl.textContent = t;
          // 自分の手札 (0) のみクリックで捨てられる（かつ手番でかつ手札が14枚のとき）
          if(i===0){
            tileEl.addEventListener('click',()=>{ discardFromHand(0,j); });
          } else {
            tileEl.classList.add('locked');
          }
          el.appendChild(tileEl);
        }
      }
      // 画面下の手札コピー（簡易ビュー）
      document.getElementById('hand-bottom').innerHTML = document.getElementById('hand-0').innerHTML;
      document.getElementById('hand-top').innerHTML = document.getElementById('hand-2').innerHTML;
      setActivePlayerUI(state.turn);
      // draw button enabled only if it's player's turn and can draw
      drawBtn.disabled = !(state.turn === 0 && canDraw(0));
    }

    function renderDiscards(){
      discardsEl.innerHTML = '';
      for(const d of state.discards){
        const tileEl = document.createElement('div');
        tileEl.className = 'tile locked';
        tileEl.style.width = '100%';
        tileEl.style.height = '100%';
        tileEl.textContent = `${d.player}:${d.tile}`;
        tileEl.title = `プレイヤー ${d.player} が ${d.tile} を切りました`;
        tileEl.addEventListener('click', ()=> {
          log(`捨て牌クリック: プレイヤー ${d.player} の ${d.tile}`);
        });
        discardsEl.appendChild(tileEl);
      }
    }

    function updateWall(){
      wallEl.textContent = `山: ${state.wall.length}`;
    }

    // 配牌（親はplayer 0）
    function deal(){
      state.wall = buildWall();
      shuffle(state.wall);
      for(let i=0;i<4;i++) state.hands[i]=[];
      // 一般的な配り方（4枚刻みを3回 -> 12枚、残り1枚ずつ配る -> 13枚、親にさらに1枚）
      for(let round=0;round<3;round++){
        for(let p=0;p<4;p++){
          for(let k=0;k<4;k++){
            state.hands[p].push(state.wall.pop());
          }
        }
      }
      // 1枚ずつ配る（合計13枚）
      for(let p=0;p<4;p++){
        state.hands[p].push(state.wall.pop());
      }
      // 親(0)にさらに1枚（14枚）
      state.hands[0].push(state.wall.pop());

      // ソート（表示用）
      for(let i=0;i<4;i++) sortTiles(state.hands[i]);

      state.discards=[];
      state.turn = 0; // 親が手番
      updateWall();
      renderHands();
      renderDiscards();
      statusEl.textContent = '状態: 配牌済み（あなたが親 / 東）';
      turnEl.textContent = `ターン: ${state.turn}`;
      log('配牌しました。あなたは親（東）です。');
    }

    // 捨て牌処理（手札から）
    function discardFromHand(playerIndex, tileIndex){
      if(playerIndex !== state.turn){
        log('今のターンではありません。');
        return;
      }
      // 手番でかつ手牌が14枚（ツモ済み or 親の初手）でないと捨てられない
      if(!(state.hands[playerIndex].length % 3 === 2)){
        log('現在の手札枚数では切れません。ツモして14枚にしてから切ってください。');
        return;
      }
      const tile = state.hands[playerIndex].splice(tileIndex,1)[0];
      state.discards.unshift({player: playerIndex, tile});
      renderHands();
      renderDiscards();
      log(`プレイヤー ${playerIndex} が ${tile} を切りました。`);
      // 次のプレイヤーへ
      nextTurn();
    }

    // ツモ（指定プレイヤーに1枚引かせる）
    function drawTileFor(player){
      if(state.wall.length===0){
        log('山がありません。');
        statusEl.textContent = '状態: 山が枯れました';
        drawBtn.disabled = true;
        return null;
      }
      const tile = state.wall.pop();
      state.hands[player].push(tile);
      sortTiles(state.hands[player]);
      updateWall();
      renderHands();
      log(`プレイヤー ${player} が ${tile} をツモしました。`);
      return tile;
    }

    // ボタン経由のツモ（プレイヤー0専用）
    function drawTile(){
      if(state.turn !== 0){
        log('あなたのターンではありません。');
        return;
      }
      if(!canDraw(0)){
        log('現在ツモできる状態ではありません（手牌枚数を確認してください）。');
        return;
      }
      drawTileFor(0);
    }

    // ツモ可能かチェック（簡易ルール: ツモは手牌が13枚の時のみ許可）
    function canDraw(player){
      // mahjong: 通常ツモは手牌13枚のときに行い14枚にする -> 13 % 3 === 1
      return state.hands[player].length % 3 === 1;
    }

    // 単純なターン進行
    function nextTurn(){
      state.turn = (state.turn + 1) % 4;
      statusEl.textContent = `状態: プレイヤー ${state.turn} のターン`;
      turnEl.textContent = `ターン: ${state.turn}`;
      renderHands();
    }

    // 自動プレイ（極簡易：AI はツモして左端の牌を切る）
    function aiPlayOnceFor(player){
      // player に対して安全にツモ→切りを行う（state.turn と連動）
      // 現在の実装では aiPlayOnceFor は state.turn が player のときに呼ぶべき
      if(!canDraw(player)){
        // 既に14枚持っている、または手札枚数が整っていない場合は強制的に切る（安全策）
        if(state.hands[player].length > 0){
          const tile = state.hands[player].splice(0,1)[0];
          state.discards.unshift({player, tile});
          renderHands();renderDiscards();
          log(`AI (プレイヤー ${player}) が ${tile} を切りました（強制）。`);
          nextTurn();
        } else {
          nextTurn();
        }
        return;
      }
      // ツモ
      const drawn = drawTileFor(player);
      if(drawn===null){
        // 山なし
        return;
      }
      // 少し待ってから切る（UIが追従しやすいように）
      setTimeout(()=>{
        // AIのシンプル戦略: 最初の牌を切る
        if(state.hands[player].length > 0){
          const tile = state.hands[player].splice(0,1)[0];
          state.discards.unshift({player, tile});
          renderHands();renderDiscards();
          log(`AI (プレイヤー ${player}) が ${tile} を切りました。`);
        }
        nextTurn();
      }, 350);
    }

    // ------- ボタンイベント --------
    document.getElementById('btn-deal').addEventListener('click', deal);
    document.getElementById('btn-draw').addEventListener('click', ()=>{
      drawTile();
    });
    document.getElementById('btn-reset').addEventListener('click', ()=>{
      state.wall=[];state.hands=[[],[],[],[]];state.discards=[];state.turn=0;
      updateWall();renderHands();renderDiscards();
      statusEl.textContent = '状態: リセット済み';
      turnEl.textContent = 'ターン: -';
      log('ゲームをリセットしました。');
    });

    document.getElementById('btn-auto-play').addEventListener('click', ()=>{
      // 簡易AIで数手だけ進めるサンプル
      // 各プレイヤーを巡回して、AIは自動ツモ切り、自分も自動でツモ切りする（開発用）
      const steps = 12;
      let i = 0;
      function step(){
        if(i>=steps) return;
        // 現在のターンのプレイヤーに応じた処理
        const p = state.turn;
        if(p === 0){
          // 自分: 自動でツモして切る（開発用）
          if(canDraw(0)){
            drawTileFor(0);
            setTimeout(()=>{
              if(state.hands[0].length){
                const t = state.hands[0].pop(); // シンプルに最後の牌を切る
                state.discards.unshift({player:0,tile:t});
                renderHands();renderDiscards();log(`あなた（自動）が ${t} を切りました。`);
                nextTurn();
                i++; step();
              } else {
                nextTurn(); i++; step();
              }
            }, 240);
          } else {
            // 親の初手などでツモ不要な場合は親が切る（もし14枚ある場合）
            if(state.hands[0].length % 3 === 2 && state.hands[0].length>0){
              const t = state.hands[0].pop();
              state.discards.unshift({player:0,tile:t});
              renderHands();renderDiscards();log(`あなた（自動）が ${t} を切りました。`);
              nextTurn(); i++; step();
            } else {
              nextTurn(); i++; step();
            }
          }
        } else {
          // AI のターン
          aiPlayOnceFor(p);
          // AIPlayOnceFor が nextTurn を呼ぶので少し待つ
          setTimeout(()=>{ i++; step(); }, 800);
        }
      }
      step();
    });

    document.getElementById('btn-show-tiles').addEventListener('click', ()=>{
      alert('牌表現: 1m-9m (萬子), 1p-9p (筒子), 1s-9s (索子), E S W N (東南西北), P(白) F(發) C(中)');
    });

    // 役判定ボタンの処理（yaku.js の YakuEvaluator を使用）
    document.getElementById('btn-eval-yaku').addEventListener('click', ()=>{
      try{
        const myHand = state.hands[0].slice(); // 自分(東)の手牌
        if(myHand.length !== 14){
          alert('役判定には手牌14枚が必要です（現在: ' + myHand.length + '枚）。\nツモして14枚にしてから判定してください。');
          return;
        }
        if(!window.YakuEvaluator){
          alert('yaku.js が読み込まれていません。yaku.js を index.html と同じディレクトリに配置してください。');
          return;
        }
        const res = window.YakuEvaluator.evaluateHand(myHand, { seatWind: 0 }); // 0=東
        if(!res.agari){
          log('役判定: 和了形ではありません。理由: ' + (res.reason || '該当なし'));
          alert('和了形ではありません。\n理由: ' + (res.reason || '無し'));
          return;
        }
        // 表示
        let msg = '和了: ' + (res.yakus.length ? res.yakus.map(y=>y.name+'('+y.han+'翻)').join(', ') : '役なし（珍しい）') + '\n合計翻数: ' + res.totalHan;
        log('役判定結果: ' + msg);
        alert(msg);
      }catch(e){
        console.error(e); alert('役判定中にエラーが発生しました: ' + e.message);
      }
    });

    // 初期描画
    updateWall();
    renderHands();
    renderDiscards();
    log('ベースページを読み込みました。配牌ボタンでゲームを開始できます。');

    // --- 今後の拡張案（コメント） ---
    // - 牌の画像やSVGを用意し、見た目を向上（外部CSS/アセットを追加）
    // - 役判定、和了処理、得点計算（役判定は別ファイルに分けるのを推奨）
    // - 鳴き（ポン・チー・カン）、副露テロップ、ツモやロンの割り込み処理（イベント管理の整備が必要）
    // - ネットワーク対戦（サーバ／WebSocket）や観戦モード
  </script>
</body>
</html>
